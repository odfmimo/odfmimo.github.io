<!DOCTYPE html>
<html lang="en">
    <head>
        <title>ComfyUI</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
        <link rel="shortcut icon" href="#">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css">
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');
            body {
                --bs-body-font-family: "Roboto", serif;
            }
        </style>
        <script>
            let readyPromise = new Promise(async resolve => {
                if (history.state != null) {
                    history.back();
                }
                else {
                    resolve();
                }
            });
        </script>
    </head>
    <body>
        <div id="app">
            <template v-if="true">
                <template v-if="object_info && workflows">
                    <div class="position-absolute w-100 h-100 bg-black" v-if="image_number != null">
                        <div class="w-100 h-100 carousel slide">
                            <div class="w-100 h-100 carousel-inner">
                                <div class="w-100 h-100 carousel-item active">
                                    <img class="w-100 h-100 object-fit-scale" :src="workflow_images[image_number]['src']">
                                </div>
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-slide="prev" @click="image_number = Math.max(0, image_number - 1)">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-slide="next" @click="image_number = Math.min(workflow_images.length - 1, image_number + 1)">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            </button>                    
                        </div>
                    </div>
                    <div class="p-3" v-show="image_number == null">
                        <div class="d-flex flex-column gap-3" v-if="temp_workflow">
                            <div class="d-flex gap-2" style="max-width: 100%;">
                                <select class="form-select flex-shrink-1" style="width: 20em; min-width: 0;" @change="edit_workflow(editing_workflow_name)" v-model="editing_workflow_name">
                                    <option v-for="workflow in workflows" :value="workflow.name">{{ workflow.name }}</option>
                                </select>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-secondary" @click="temp_workflow=null">Close</button>
                                    <button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" data-bs-reference="parent"></button>
                                    <ul class="dropdown-menu">
                                        <li><span class="dropdown-item" @click="add_workflow()">Add</span></li>
                                        <li><span class="dropdown-item" @click="clone_workflow(editing_workflow_name)">Clone</span></li>
                                        <li><span class="dropdown-item" @click="remove_workflow(editing_workflow_name)">Remove</span></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="d-flex gap-2" style="max-width: 100%;">
                                <input class="form-control flex-shrink-1" style="width: 20em; min-width: 0;" :class="{'is-invalid': !is_valid_workflow_name}" v-model="temp_workflow.name">
                                <button type="button" class="btn btn-success" @click="save_workflow()">Save</button>
                            </div>
                            <div @input="autocomplete_input($event)" @focusout="filtered_autocomplete = null">
                                <div class="d-flex flex-column gap-3">
                                    <div class="d-flex flex-wrap gap-3">
                                        <div>
                                            Checkpoint
                                            <select class="form-select" style="max-width: 30em;" v-model="temp_workflow.workflow.checkpoint">
                                                <option v-for="checkpoint in object_info['CheckpointLoaderSimple']['input']['required']['ckpt_name'][0]" :value="checkpoint">{{ checkpoint }}</option>
                                            </select>
                                        </div>
                                        <div>
                                            CLIP Set Last Layer
                                            <div class="input-group">
                                                <div class="input-group-text">
                                                    <input class="form-check-input mt-0" type="checkbox" v-model="temp_workflow.workflow.clip_set_last_layer_bool">
                                                </div>
                                                <input type="number" class="form-control" :disabled="!temp_workflow.workflow.clip_set_last_layer_bool" v-bind="object_info['CLIPSetLastLayer']['input']['required']['stop_at_clip_layer'][1]" v-model="temp_workflow.workflow.stop_at_clip_layer" >   
                                            </div>                             
                                        </div>
                                        <div>
                                            Size Preset
                                            <select class="form-select" v-model="temp_workflow.workflow.size_preset">
                                                <option v-for="size_preset in object_info['EmptyLatentImageFromPresetsSDXL']['input']['required']['preset'][0]" :value="size_preset">{{ size_preset }}</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        Lora
                                        <div class="d-flex flex-column align-items-start gap-1" v-if="temp_workflow.workflow.loras">
                                            <div class="card" v-for="lora in temp_workflow.workflow.loras">
                                                <div class="card-body">
                                                    <div class="d-flex flex-column gap-3">
                                                        <div>
                                                            <button type="button" class="btn btn-secondary" @click="remove_lora(lora)">Remove</button>
                                                        </div>
                                                        <div class="d-flex flex-wrap gap-3">
                                                            <div>
                                                                Lora Name
                                                                <select class="form-select" v-model="lora.lora_name">
                                                                    <option v-for="lora_name in object_info['LoraLoader']['input']['required']['lora_name'][0]" :value="lora_name">{{ lora_name }}</option>
                                                                </select>
                                                            </div>
                                                            <div>
                                                                Strength Model
                                                                <input type="number" class="form-control" v-bind="object_info['LoraLoader']['input']['required']['strength_model'][1]" v-model="lora.strength_model">
                                                            </div>
                                                            <div>
                                                                Strength Clip
                                                                <input type="number" class="form-control" v-bind="object_info['LoraLoader']['input']['required']['strength_clip'][1]" v-model="lora.strength_clip">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="pt-1">
                                            <button type="button" class="btn btn-secondary" @click="add_lora">Add</button>
                                        </div>
                                    </div>
                                    <div class="d-flex flex-wrap gap-3">
                                        <div>
                                            Steps
                                            <input type="number" class="form-control" v-bind="object_info['KSampler']['input']['required']['steps'][1]" v-model="temp_workflow.workflow.steps">
                                        </div>
                                        <div>
                                            CFG
                                            <input type="number" class="form-control" v-bind="object_info['KSampler']['input']['required']['cfg'][1]" v-model="temp_workflow.workflow.cfg">
                                        </div>
                                        <div>
                                            Sampler
                                            <select class="form-select" v-model="temp_workflow.workflow.sampler_name">
                                                <option v-for="sampler_name in object_info['KSampler']['input']['required']['sampler_name'][0]" :value="sampler_name">{{ sampler_name }}</option>
                                            </select>
                                        </div>
                                        <div>
                                            Scheduler
                                            <select class="form-select" v-model="temp_workflow.workflow.scheduler">
                                                <option v-for="scheduler in object_info['KSampler']['input']['required']['scheduler'][0]" :value="scheduler">{{ scheduler }}</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <div>
                                            <input class="form-check-input" type="checkbox" v-model="temp_workflow.workflow.face_detailer_bool">
                                            Face Detailer
                                        </div>
                                    </div>
                                    <div>
                                        Positive Base
                                        <textarea class="form-control" v-model="temp_workflow.workflow.positive_text"></textarea>
                                    </div>
                                    <div>
                                        Negative Base
                                        <textarea class="form-control" v-model="temp_workflow.workflow.negative_text"></textarea>
                                    </div>
                                    <div>
                                        Regional Conditioning
                                        <div class="d-flex flex-column gap-1" v-if="temp_workflow.workflow.conditions">
                                            <div class="card" v-for="condition in temp_workflow.workflow.conditions">
                                                <div class="card-body">
                                                    <div class="d-flex flex-column gap-3">
                                                        <div>
                                                            <button type="button" class="btn btn-secondary" @click="remove_condition(condition)">Remove</button>
                                                        </div>
                                                        <div class="d-flex gap-3">
                                                            <div>
                                                                Width
                                                                <input type="number" class="form-control" v-bind="object_info['ConditioningSetAreaPercentage']['input']['required']['width'][1]" v-model="condition.width">
                                                            </div>
                                                            <div>
                                                                Height
                                                                <input type="number" class="form-control" v-bind="object_info['ConditioningSetAreaPercentage']['input']['required']['height'][1]" v-model="condition.height">
                                                            </div>
                                                            <div>
                                                                X
                                                                <input type="number" class="form-control" v-bind="object_info['ConditioningSetAreaPercentage']['input']['required']['x'][1]" v-model="condition.x">
                                                            </div>
                                                            <div>
                                                                Y
                                                                <input type="number" class="form-control" v-bind="object_info['ConditioningSetAreaPercentage']['input']['required']['y'][1]" v-model="condition.y">
                                                            </div>
                                                        </div>
                                                        <div>
                                                            Text
                                                            <textarea class="form-control" v-model="condition.text"></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="pt-1">
                                            <button type="button" class="btn btn-secondary" @click="add_condition">Add</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="position-absolute overflow-x-auto" ref="autocomplete">
                                    <ul class="list-group list-group-horizontal" v-if="filtered_autocomplete">
                                        <li class="list-group-item text-nowrap" v-for="item in filtered_autocomplete">
                                            <span>{{ item.name }}</span><span class="badge text-bg-secondary">{{ item.count }}</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex flex-column gap-3" v-else>
                            <div class="d-flex flex-wrap gap-3">
                                <div class="d-flex gap-2" style="max-width: 100%;">
                                    <select class="form-select flex-shrink-1" style="width: 20em; min-width: 0;" v-model="active_workflow_name">
                                        <option v-for="workflow in workflows" :value="workflow.name">{{ workflow.name }}</option>
                                    </select>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-secondary" @click="edit_workflow(active_workflow_name)">Edit</button>
                                        <button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" data-bs-reference="parent"></button>
                                        <ul class="dropdown-menu">
                                            <li><span class="dropdown-item" @click="upload_workflows">Upload</span></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="d-flex gap-2">
                                    <div class="input-group flex-nowrap">
                                        <button type="button" class="btn btn-primary" @click="queue_prompt(batch_count)">Queue</button>
                                        <input type="number" class="form-control" min="1" max="100" step="1" v-model="batch_count">
                                    </div>
                                    <button type="button" class="btn btn-danger text-nowrap" @click="stop">
                                        Stop <span class="badge text-bg-secondary">{{ queue_remaining }}</span>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <div class="d-flex flex-column gap-3 align-items-start">
                                    <div class="d-flex gap-2 align-items-center">
                                        <button type="button" class="btn btn-secondary" @click="clear_workflow_prompt_ids">Clear</button>
                                        <button type="button" class="btn btn-dark" @click="download_workflow_images">Download</button>
                                        <div class="input-group">
                                            <span class="input-group-text">{{ workflow_images.length }} / {{ prompt_ids.filter(prompt_id => prompt_id.workflow_name == active_workflow_name).length }}</span>
                                            <span class="input-group-text">
                                                <input class="form-check-input mt-0" type="checkbox" v-model="is_fixed_queue_size">
                                            </span>
                                        </div>
                                    </div>
                                    <div class="container">
                                        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">
                                            <div class="col" v-for="(image, index) in workflow_images">
                                                <div class="position-relative">
                                                    <img class="w-100" :src="image['src']" @click="view_image(index)">
                                                    <button type="button" class="btn-close position-absolute top-0 end-0" @click="delete_image(index)"></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
                <div class="d-flex flex-column align-items-start gap-2 p-3" v-else>
                    <div>
                        Server Address
                        <input class="form-control flex-shrink-1" style="width: 30em; min-width: 0;" :class="{'is-invalid': is_valid_server_address == false}" @input="is_valid_server_address = null" v-model="server_address">
                    </div>
                    <div>
                        Access Token
                        <input class="form-control flex-shrink-1" style="width: 30em; min-width: 0;" :class="{'is-invalid': is_valid_access_token == false}" @input="is_valid_access_token = null" v-model="access_token">
                    </div>
                    <button type="button" class="btn btn-primary" :disabled="is_connecting" @click="connect">Connect</button>
                </div>
            </template>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/js/bootstrap.bundle.min.js"></script>
        <script type="module">
            await readyPromise;
            
            const uuid41 = () => ('xxxxxxxx-xxxx-4xxx-Nxxx-xxxxxxxxxxxx'
                .replace(/x/g, () =>  ((Math.random()*16)|0).toString(16))
                .replace(/N/g, () => ((Math.random()*4)|0 + 8).toString(16)));
            
            const { createApp, toRaw } = await import('https://unpkg.com/vue@3/dist/vue.esm-browser.js')
            const { Octokit } = await import("https://esm.sh/@octokit/core");
            const { default: JSZip } = await import('https://cdn.jsdelivr.net/npm/jszip@3/+esm');

            createApp({
                data() {
                    let settings = {};
                    try {
                        settings = JSON.parse(localStorage.getItem("ComfyUI")) ?? {};
                    }
                    catch (e) {}

                    return {
                        client_id: uuid41(),
                        server_address: settings.server_address ?? "http://127.0.0.1:8188",
                        is_valid_server_address: null,
                        access_token: settings.access_token,
                        is_valid_access_token: null,
                        is_connecting: false,
                        object_info: null,
                        workflows: null,
                        active_workflow_name: null,
                        editing_workflow_name: null,
                        temp_workflow: null,
                        queue_remaining: 0,
                        filtered_autocomplete: null,
                        batch_count: 1,
                        images: [],
                        image_number: null,
                        prompt_ids: [],
                        is_fixed_queue_size: false,
                        queue_promise: Promise.resolve(),
                    }
                },
                computed: {
                    is_valid_workflow_name() {
                        if (this.temp_workflow) {
                            if (this.temp_workflow.name.trim() == "") return false;
                            if (!this.editing_workflow_name || this.temp_workflow.name != this.editing_workflow_name) {
                                if (this.workflows.find(workflow => workflow.name == this.temp_workflow.name)) return false;
                            }
                        }
                        return true;
                    },
                    workflow_images() {
                        let prompt_ids = this.prompt_ids.filter(prompt_id => prompt_id.workflow_name == this.active_workflow_name).map(prompt_id => prompt_id.prompt_id);
                        return this.images.filter(image => prompt_ids.includes(image['prompt_id']));
                    },
                },
                methods: {
                    get_default(class_type) {
                        let inputs = {};
                        let object_info = this.object_info[class_type];
                        for (let [key, value] of Object.entries(object_info['input']['required'])) {
                            if (!(key in inputs)) {
                                if (value[1] instanceof Object && 'default' in value[1]) {
                                    inputs[key] = value[1]?.['default'];
                                }
                                else if (Array.isArray(value[0])) {
                                    inputs[key] = value[0][0];
                                }
                                else inputs[key] = null;
                            }
                        }
                        return inputs;
                    },
                    async queue_prompt(batch_count = 1) {
                        let workflow = null;
                        if (!this.temp_workflow && this.active_workflow_name) {
                            workflow = this.workflows.find(workflow => workflow.name == this.active_workflow_name);
                        }
                        else return;

                        let workflow_name = workflow.name;
                        let workflow_ = structuredClone(toRaw(workflow.workflow));

                        await this.queue_promise;
                        this.queue_promise = new Promise(async resolve => {
                            let prompts = [];
                            for (let _ of Array(batch_count)) {
                                let prompt = {};
                                const add_node = (class_type, inputs_ = {}) => {
                                    let inputs = structuredClone(inputs_);
                                    let object_info = this.object_info[class_type];
                                    for (let [key, value] of Object.entries(object_info['input']['required'])) {
                                        if (!(key in inputs)) {
                                            if (value[1] instanceof Object && 'default' in value[1]) {
                                                inputs[key] = value[1]?.['default'];
                                            }
                                            else if (Array.isArray(value[0])) {
                                                inputs[key] = value[0][0];
                                            }
                                            else {
                                                if (value[0] == "STRING") {
                                                    inputs[key] = "";
                                                }
                                            }
                                        }
                                    }
                                    let node = {class_type, inputs};
        
                                    let key = String(Math.max(0, ...Object.keys(prompt).map(key => Number(key))) + 1);
                                    prompt[key] = node;
                                    
                                    let outputs = {};
                                    for (let [index, output_name] of object_info['output_name'].entries()) {
                                        outputs[output_name] = [key, index];
                                    }
                                    return outputs;
                                };
                                const get_seed = (seed_info) => {
                                    let max = seed_info['max'] ?? (Math.pow(2, 64) - 1);
                                    let min = seed_info['min'] ?? 0;
                                    return Math.floor(Math.random() * (max - min) + min);
                                };
        
                                let CheckpointLoaderSimple_node = add_node('CheckpointLoaderSimple', {ckpt_name: workflow_.checkpoint});
                                let model_output = CheckpointLoaderSimple_node['MODEL'];
                                let clip_output = CheckpointLoaderSimple_node['CLIP'];
                                let vae_output = CheckpointLoaderSimple_node['VAE'];
        
                                if (workflow_.loras) {
                                    for (let lora of workflow_.loras) {
                                        let LoraLoader_node = add_node('LoraLoader', {
                                            model: model_output, clip: clip_output,
                                            lora_name: lora.lora_name, strength_model: lora.strength_model, strength_clip: lora.strength_clip,
                                        });
                                        model_output = LoraLoader_node['MODEL'];
                                        clip_output = LoraLoader_node['CLIP'];
                                    }
                                }
        
                                if (workflow_.clip_set_last_layer_bool) {
                                    let CLIPSetLastLayer_node = add_node('CLIPSetLastLayer', {stop_at_clip_layer: workflow_.stop_at_clip_layer, clip: clip_output});
                                    clip_output = CLIPSetLastLayer_node['CLIP'];
                                }
        
                                let CLIPTextEncode_positive_node = add_node('CLIPTextEncode', {
                                    text: add_node('DPRandomGenerator', {
                                        text: workflow_.positive_text,
                                        seed: get_seed(this.object_info['DPRandomGenerator']['input']['required']['seed'][1]),
                                    })['STRING'],
                                    clip: clip_output
                                });
                                let positive_output = CLIPTextEncode_positive_node['CONDITIONING'];
                                let CLIPTextEncode_negative_node = add_node('CLIPTextEncode', {
                                    text: add_node('DPRandomGenerator', {
                                        text: workflow_.negative_text,
                                        seed: get_seed(this.object_info['DPRandomGenerator']['input']['required']['seed'][1]),
                                    })['STRING'],
                                    clip: clip_output
                                });
                                let negative_output = CLIPTextEncode_negative_node['CONDITIONING'];
        
                                if (workflow_.conditions) {
                                    for (let condition of workflow_.conditions) {
                                        let CLIPTextEncode_node = add_node('CLIPTextEncode', {
                                            text: add_node('DPRandomGenerator', {
                                                text: condition.text,
                                                seed: get_seed(this.object_info['DPRandomGenerator']['input']['required']['seed'][1]),
                                            })['STRING'],
                                            clip: clip_output
                                        });
                                        let ConditioningSetAreaPercentage_node = add_node('ConditioningSetAreaPercentage', {
                                            conditioning: CLIPTextEncode_node['CONDITIONING'],
                                            width: condition.width, height: condition.height, x: condition.x, y: condition.y
                                        });
                                        let ConditioningConcat_node = add_node('ConditioningConcat', {conditioning_to: positive_output, conditioning_from: ConditioningSetAreaPercentage_node['CONDITIONING']});
                                        positive_output = ConditioningConcat_node['CONDITIONING'];
                                    }
                                }
        
                                let EmptyLatentImageFromPresetsSDXL_node = add_node('EmptyLatentImageFromPresetsSDXL', {preset: workflow_.size_preset});
        
                                let KSampler_node = add_node('KSampler', {
                                    model: model_output,positive: positive_output, negative: negative_output, latent_image: EmptyLatentImageFromPresetsSDXL_node['latent'],
                                    seed: get_seed(this.object_info['KSampler']['input']['required']['seed'][1]),
                                    steps: workflow_.steps, cfg: workflow_.cfg, sampler_name: workflow_.sampler_name, scheduler: workflow_.scheduler,
                                });
                                
                                let VAEDecode_node = add_node('VAEDecode', {samples: KSampler_node['LATENT'], vae: vae_output});
                                let image_output = VAEDecode_node['IMAGE'];
        
                                if (workflow_.face_detailer_bool) {
                                    let UltralyticsDetectorProvider_node = add_node('UltralyticsDetectorProvider');
                                    let FaceDetailer_node = add_node('FaceDetailer', {
                                        image: image_output, model: model_output, clip: clip_output, vae: vae_output, positive: positive_output, negative: negative_output,
                                        seed: get_seed(this.object_info['FaceDetailer']['input']['required']['seed'][1]),
                                        steps: workflow_.steps, cfg: workflow_.cfg, sampler_name: workflow_.sampler_name, scheduler: workflow_.scheduler,
                                        bbox_detector: UltralyticsDetectorProvider_node['BBOX_DETECTOR'],
                                    });
                                    image_output = FaceDetailer_node['image'];
                                }
        
                                add_node('PreviewImage', {images: image_output});
    
                                prompts.push(prompt);
                            }

                            for (let prompt of prompts) {
                                let prompt_id = (await (await fetch(`${this.server_address}/api/prompt`, {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({"prompt": prompt, "client_id": this.client_id}),
                                })).json())['prompt_id'];
    
                                this.prompt_ids.push({prompt_id: prompt_id, workflow_name: workflow_name});
                            }

                            resolve();
                        });
                    },
                    async remove_prompts(prompt_ids) {
                        for (let prompt_id of prompt_ids) {
                            let idx = this.prompt_ids.indexOf(prompt_id);
                            if (idx >= 0) {
                                this.prompt_ids.splice(idx, 1);
                            }
                        }
                        
                        let prompt_ids_ = prompt_ids.map(prompt_id => prompt_id.prompt_id);
                        await fetch(`${this.server_address}/api/queue`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({"delete": prompt_ids_}),
                        });
                        await fetch(`${this.server_address}/api/history`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({"delete": prompt_ids_}),
                        });

                        let running_prompt_id = (await (await fetch(`${this.server_address}/api/queue`)).json())['queue_running'][0]?.[1];
                        if (running_prompt_id && prompt_ids_.includes(running_prompt_id)) {
                            await fetch(`${this.server_address}/api/interrupt`, {
                                method: "POST",
                            });
                        }
                    },
                    async stop() {
                        let queue = await (await fetch(`${this.server_address}/api/queue`)).json();
                        let queue_prompt_ids_ = [...queue['queue_running'], ...queue['queue_pending']].map(queue => queue[1]);
                        let prompt_ids = this.prompt_ids.filter(prompt_id => queue_prompt_ids_.includes(prompt_id.prompt_id));
                        this.remove_prompts(prompt_ids);
                    },
                    async retrieve() {
                        await Promise.all([
                            (async _ => {
                                let images = [];
                                Object.values((await (await fetch(`${this.server_address}/api/history`)).json()))
                                    .sort((a, b) => (a['prompt']?.[0] > b['prompt']?.[0]))
                                    .forEach(history => {
                                        for (let node_id of Object.keys(history['outputs'])) {
                                            let node_output = history['outputs'][node_id];
                                            if ('images' in node_output) {
                                                for (let image of node_output['images']) {
                                                    let data = {"filename": image['filename'], "subfolder": image['subfolder'], "type": image['type']};
                                                    let params = new URLSearchParams(data);
                                                    let url_values = params.toString();
                                                    data['src'] = `${this.server_address}/api/view?${url_values}`;
                                                    data['prompt_id'] = history['prompt']?.[1];
                                                    images.push(data);
                                                }
                                            }
                                        }
                                    });
                                this.images = images;
                            })(),
                            (async _ => {
                                let queue = await (await fetch(`${this.server_address}/api/queue`)).json();
                                this.queue_remaining = queue['queue_running'].length + queue['queue_pending'].length;
                            })(),
                        ]);
                    },
                    edit_workflow(workflow_name) {
                        if (workflow_name) {
                            let workflow = this.workflows.find(workflow => workflow.name == workflow_name);
                            if (workflow) {
                                this.active_workflow_name = workflow.name;
                                this.editing_workflow_name = workflow.name;
                                this.temp_workflow = {
                                    name: workflow.name,
                                    workflow: structuredClone(toRaw(workflow.workflow)),
                                };
                            }
                        }
                        else this.add_workflow();
                    },
                    add_workflow() {
                        let default_CheckpointLoaderSimple = this.get_default('CheckpointLoaderSimple');
                        let default_EmptyLatentImageFromPresetsSDXL = this.get_default('EmptyLatentImageFromPresetsSDXL');
                        let default_KSampler = this.get_default('KSampler');
                        let default_CLIPSetLastLayer = this.get_default('CLIPSetLastLayer');
                        
                        this.editing_workflow_name = null;
                        this.temp_workflow = {
                            name: "",
                            workflow: {
                                checkpoint: default_CheckpointLoaderSimple['ckpt_name'],
                                size_preset: default_EmptyLatentImageFromPresetsSDXL['preset'],
                                steps: default_KSampler['steps'],
                                cfg: default_KSampler['cfg'],
                                sampler_name: default_KSampler['sampler_name'],
                                scheduler: default_KSampler['scheduler'],
                                stop_at_clip_layer: default_CLIPSetLastLayer['stop_at_clip_layer'],
                            }
                        };
                    },
                    clone_workflow(workflow_name) {
                        if (workflow_name) {
                            let workflow = this.workflows.find(workflow => workflow.name == workflow_name);
                            if (workflow) {
                                this.editing_workflow_name = null;
                                this.temp_workflow = {
                                    name: workflow.name,
                                    workflow: structuredClone(toRaw(workflow.workflow)),
                                };
                            }
                        }
                    },
                    remove_workflow(workflow_name) {
                        if (workflow_name) {
                            let idx = this.workflows.findIndex(workflow => workflow.name == workflow_name);
                            if (idx >= 0) {
                                this.workflows.splice(idx, 1);
                                this.remove_prompts(this.prompt_ids.filter(prompt_id => prompt_id.workflow_name == workflow_name));
                                if (workflow_name == this.active_workflow_name) {
                                    if (this.workflows.length == 0) {
                                        this.active_workflow_name = null;
                                    }
                                    else if (idx < this.workflows.length) {
                                        this.active_workflow_name = this.workflows[idx].name;
                                    }
                                    else {
                                        this.active_workflow_name = this.workflows[this.workflows.length - 1].name;
                                    }
                                }
                            }
                        }
                    },
                    save_workflow() {
                        if (this.is_valid_workflow_name) {
                            if (this.editing_workflow_name) {
                                let editing_workflow = this.workflows.find(workflow => workflow.name == this.editing_workflow_name);
                                this.remove_prompts(this.prompt_ids.filter(prompt_id => prompt_id.workflow_name == this.editing_workflow_name));
                                editing_workflow.name = this.temp_workflow.name;
                                editing_workflow.workflow = structuredClone(toRaw(this.temp_workflow.workflow));
                            }
                            else {
                                this.workflows.push({
                                    name: this.temp_workflow.name,
                                    workflow: structuredClone(toRaw(this.temp_workflow.workflow))
                                });
                            }
                            
                            this.edit_workflow(this.temp_workflow.name);
                        }
                    },
                    /*upload_workflow() {
                        let input = document.createElement('input');
                        input.type = 'file';
                        input.style.display = 'none';
                        input.addEventListener('change', _ => {
                            for (let file of input.files) {
                                const reader = new FileReader();
                                reader.addEventListener('load', _ => {
                                    let workflow = JSON.parse(reader.result);
                                    this.temp_workflow = {
                                        name: workflow.name,
                                        workflow: workflow.workflow,
                                    };
                                });
                                reader.readAsText(file);
                            }
                        });
                        input.click();
                    },
                    download_workflow() {
                        if (this.active_workflow_name) {
                            let workflow = structuredClone(toRaw(this.workflows.find(workflow => workflow.name == this.active_workflow_name)));
                            let url = window.URL.createObjectURL(new Blob([JSON.stringify(workflow)], {type: 'application/octet-stream'}));
                            const iframe = document.createElement('iframe');
                            iframe.style.display = 'none';
                            iframe.addEventListener('load', _ => {
                                let a = iframe.contentDocument.createElement('a');
                                a.download = `${workflow.name}.json`
                                a.href = url;
                                a.click();
                                setTimeout(_ => {
                                    iframe.remove();
                                    window.URL.revokeObjectURL(url);
                                }, 100);
                            }, { once: true });
                            document.body.appendChild(iframe);
                        }
                    },*/
                    add_lora() {
                        if (!this.temp_workflow.workflow.loras) {
                            this.temp_workflow.workflow.loras = [];
                        }
                        let default_LoraLoader = this.get_default('LoraLoader');
                        this.temp_workflow.workflow.loras.push({
                            lora_name: default_LoraLoader['lora_name'],
                            strength_model: default_LoraLoader['strength_model'],
                            strength_clip: default_LoraLoader['strength_clip'],
                        });
                    },
                    remove_lora(lora) {
                        let idx = this.temp_workflow.workflow.loras.indexOf(lora);
                        this.temp_workflow.workflow.loras.splice(idx, 1);
                    },
                    add_condition() {
                        if (!this.temp_workflow.workflow.conditions) {
                            this.temp_workflow.workflow.conditions = [];
                        }
                        let default_ConditioningSetAreaPercentage = this.get_default('ConditioningSetAreaPercentage');
                        this.temp_workflow.workflow.conditions.push({
                            width: default_ConditioningSetAreaPercentage['width'],
                            height: default_ConditioningSetAreaPercentage['height'],
                            x: default_ConditioningSetAreaPercentage['x'],
                            y: default_ConditioningSetAreaPercentage['y'],
                        });
                    },
                    remove_condition(condition) {
                        let idx = this.temp_workflow.workflow.conditions.indexOf(condition);
                        this.temp_workflow.workflow.conditions.splice(idx, 1);
                    },
                    connect_socket() {
                        try { this.socket.close(); } catch (e) {}
                        this.socket = new WebSocket(`${this.server_address}/ws?clientId=${this.client_id}`);
                        this.socket.addEventListener("message", async event => {
                            // console.log("Message from server ", event.data);
                            let data = {}
                            try { data = JSON.parse(event.data); } catch(e) {}
                            if (data.type == "status") {
                                this.retrieve();
                            }
                        });
                    },
                    async connect() {
                        this.is_connecting = true;
                        try {
                            this.connect_socket();

                            this.object_info = await (await fetch(`${this.server_address}/api/object_info`)).json();
                            
                            try {
                                this.autocomplete = (await (await fetch(`${this.server_address}/pysssss/autocomplete`)).text())
                                    .split('\n').map(item => item.split(','))
                                    .map(item => ({
                                        name: ['(', ')', '[', ']'].reduce((acc, cur) => acc.replaceAll(cur, '\\' + cur), item[0].trim().replaceAll('_', ' ')),
                                        count: Number(item[1].trim())
                                    }));
                            }
                            catch (e) {}

                            let settings = {};
                            try {
                                settings = JSON.parse(localStorage.getItem("ComfyUI")) ?? {};
                            }
                            catch (e) {}
                            settings.server_address = this.server_address;
                            localStorage.setItem("ComfyUI", JSON.stringify(settings));
                        }
                        catch (e) {
                            console.error(e);
                            this.is_valid_server_address = false;
                        }

                        try {
                            if (this.access_token) {
                                this.octokit = new Octokit({
                                    auth: this.access_token
                                });
                                await this.download_workflows();

                                let settings = {};
                                try {
                                    settings = JSON.parse(localStorage.getItem("ComfyUI")) ?? {};
                                }
                                catch (e) {}
                                settings.access_token = this.access_token;
                                localStorage.setItem("ComfyUI", JSON.stringify(settings));
                            }
                            else {
                                this.is_valid_access_token = false;
                            }
                        }
                        catch (e) {
                            console.error(e);
                            this.is_valid_access_token = false;
                        }

                        this.is_connecting = false;
                    },
                    async upload_workflows() {
                        let url = "/gists";
                        const nextPattern = /(?<=<)([\S]*)(?=>; rel="Next")/i;
                        let pagesRemaining = true;
                        let found = false;
                        let files = {
                            'ComfyUI.json': {
                                content: JSON.stringify({
                                    workflows: this.workflows,
                                })
                            }
                        };
                        while (pagesRemaining) {
                            const response = await this.octokit.request(`GET ${url}`, {
                                per_page: 100,
                                headers: {
                                    'X-GitHub-Api-Version': '2022-11-28'
                                }
                            });

                            for (let gist of response.data) {
                                for (let file of Object.values(gist.files)) {
                                    if (file.filename == "ComfyUI.json") {
                                        found = true;
                                        let response = await this.octokit.request(`PATCH /gists/${gist.id}`, {
                                            files: files,
                                            headers: {
                                                'X-GitHub-Api-Version': '2022-11-28'
                                            }
                                        });
                                        console.log(response);
                                    }
                                    if (found) break;
                                }
                                if (found) break;
                            }
                            if (found) break;

                            const linkHeader = response.headers.link;

                            pagesRemaining = linkHeader && linkHeader.includes(`rel=\"next\"`);

                            if (pagesRemaining) {
                                url = linkHeader.match(nextPattern)[0];
                            }
                        }
                        if (!found) {
                            let response = await this.octokit.request(`POST /gists`, {
                                public: false,
                                files: files,
                                headers: {
                                    'X-GitHub-Api-Version': '2022-11-28'
                                }
                            });
                            console.log(response);
                        }
                    },
                    async download_workflows() {
                        let url = "/gists";
                        const nextPattern = /(?<=<)([\S]*)(?=>; rel="Next")/i;
                        let pagesRemaining = true;
                        let found = false;
                        while (pagesRemaining) {
                            const response = await this.octokit.request(`GET ${url}`, {
                                per_page: 100,
                                headers: {
                                    'X-GitHub-Api-Version': '2022-11-28'
                                }
                            });

                            for (let gist of response.data) {
                                for (let file of Object.values(gist.files)) {
                                    if (file.filename == "ComfyUI.json") {
                                        found = true;
                                        try {
                                            let json = await (await fetch(file.raw_url)).json();
                                            this.workflows = json.workflows;
                                            console.log(gist);
                                        }
                                        catch (e) {
                                            console.error(e);
                                        }
                                    }
                                    if (found) break;
                                }
                                if (found) break;
                            }
                            if (found) break;

                            const linkHeader = response.headers.link;

                            pagesRemaining = linkHeader && linkHeader.includes(`rel=\"next\"`);

                            if (pagesRemaining) {
                                url = linkHeader.match(nextPattern)[0];
                            }
                        }
                        if (!this.workflows) {
                            this.workflows = [];
                        }
                    },
                    async clear_history() {
                        await fetch(`${this.server_address}/api/history`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({"clear": true}),
                        });
                        this.images = [];
                    },
                    clear_workflow_prompt_ids() {
                        this.remove_prompts(this.prompt_ids.filter(prompt_id => prompt_id.workflow_name == this.active_workflow_name));
                    },
                    async download_workflow_images() {
                        var zip = new JSZip();
                        for (let image of this.workflow_images) {
                            let response = await fetch(image['src']);
                            let blob = await response.blob();
                            zip.file(image.filename, blob);
                        }
                        let content = await zip.generateAsync({type:"blob"});
                        const url = window.URL.createObjectURL(content);
                        const iframe = document.createElement('iframe');
                        iframe.style.display = 'none';
                        iframe.addEventListener('load', _ => {
                            let a = iframe.contentDocument.createElement('a');
                            a.href = url;
                            a.click();
                            setTimeout(_ => {
                                iframe.remove();
                                window.URL.revokeObjectURL(url);
                            }, 100);
                        }, { once: true });
                        document.body.appendChild(iframe);
                    },
                    view_image(index) {
                        history.pushState({image_number: index}, "");
                        this.image_number = index;
                    },
                    delete_image(index) {
                        let prompt_id = this.prompt_ids.find(prompt_id => prompt_id.prompt_id == this.workflow_images[index]['prompt_id']);
                        this.remove_prompts([prompt_id]);
                        if (this.is_fixed_queue_size) this.queue_prompt();
                    },
                    autocomplete_input(event) {
                        let target = event.target;
                        if (target.tagName.toLowerCase() == 'textarea') {
                            let text = target.value;
                            let end = event.target.selectionEnd;
                            let start = text.substring(0, end).lastIndexOf(',');
                            let segment = text.substring(start+1, end).trim();
                            if (segment != "") {
                                let result = this.autocomplete.filter(autocomplete => autocomplete.name.includes(segment));
                                this.filtered_autocomplete = result.slice(0, 25);
                                let target_rect = target.getBoundingClientRect();
                                let parent_rect = this.$refs.autocomplete.offsetParent.getBoundingClientRect();
                                this.$refs.autocomplete.style.top = `${target_rect.top - parent_rect.top}px`;
                                this.$refs.autocomplete.style.left = `${target_rect.left - parent_rect.left}px`;
                                this.$refs.autocomplete.style.width = `${target_rect.width}px`;
                                this.$refs.autocomplete.style.transform = 'translate(0, -100%)';
                            }
                            else this.filtered_autocomplete = null;
                        }
                    },
                },
                async created() {                    
                    window.addEventListener('popstate', e => {
                        if (history.state == null) {
                            this.image_number = null;
                        }
                    });
                    document.addEventListener("visibilitychange", e => {
                        if (document.visibilityState === "visible") {
                            if (this.object_info) {
                                this.connect_socket();
                            }
                        }
                    });
                    document.addEventListener("keydown", e => {
                        if (this.image_number != null) {
                            if (e.key == "Escape") {
                                if (history.state != null) {
                                    history.back();
                                }
                            }
                            else if (e.key == "ArrowLeft") {
                                this.image_number = Math.max(0, this.image_number - 1);
                            }
                            else if (e.key == "ArrowRight") {
                                this.image_number = Math.min(this.workflow_images.length - 1, this.image_number + 1);
                            }
                        }
                    });
                    
                    let server_address = (new URLSearchParams(location.search)).get('server_address');
                    if (server_address) {
                        this.server_address = server_address;
                    }

                    this.$watch(_ => [this.workflows, this.active_workflow_name], _ => {
                        if (!this.workflows.find(workflow => workflow.name == this.active_workflow_name)) {
                            if (this.workflows.length > 0) {
                                this.active_workflow_name = this.workflows[0].name;
                            }
                            else this.active_workflow_name = null;
                        }
                    }, { deep: true } );
                },
            }).mount('#app')
        </script>
    </body>
</html>
